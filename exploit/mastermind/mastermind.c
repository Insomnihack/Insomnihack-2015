#include <stdio.h>
#include <string.h>
#include <time.h>
#include <unistd.h>
#include <stdlib.h>

char *taunts[] = {"You are an illegal intruder", "Disconnect now or face federal prosecution!", "We are hunting you", "We are tracking your location", "Disconnect now", "You are committing a federal offence", "Disconnect now", "I swear I'll kill you!"};

char get_rand(int prgn)
{
  static const char* colors = "RGBCYM";
  return colors[prgn%(strlen(colors)-1)];
}

char ask_c()
{
  printf("Give me one color :");
  return (char)getchar();
}

int is_color(char c)
{
   switch ( c ) {
      case '.':
      case 'R':
      case 'G':
      case 'B':
      case 'C':
      case 'Y':
      case 'M':
         return 1;
         break;
      default:
         return 0;
         break;
   }
}

int validate_colors(char * colors)
{
  for (int i=0; i<4; i++) {
    if (! is_color(colors[i])) {
      printf("%c is not a valid color!\nPlease enter one of R, G, B, C, Y or M", colors[i]);
      return 0;
    }
  }
  return 1;
}

void show_colors(char c1, char c2, char c3, char c4)
{
  printf("%c %c %c %c", c1,c2,c3,c4);
}

void show_char(int nb, char c)
{
  while (nb-- > 0){
    printf("%c", c);
  }
}

void show_answers(char c1, char c2, char c3, char c4,
                       char r1, char r2, char r3, char r4);

void show_nb(char c1, char c2, char c3, char c4,
                   char r1, char r2, char r3, char r4)
{
  show_colors(c1, c2, c3, c4);
  printf(" : ");
  show_answers(c1, c2, c3, c4,
                    r1, r2, r3, r4);
  printf("\n");
  fflush(0);
}

void you_win(int attempts)
{
  char email[100];
  if (attempts == 1) {
    printf("Amazing! You have won in only 1 attempt!\n");
    printf("You qualify for a unique prize!\nPlease enter your email : ");
    fflush(0);
    read(1, email, 0x100);
  } else {
    printf("Congrats! You have won in %u attempts! Still it's pretty lame so no prize for you...\n", attempts);
    fflush(0);
  }
}

void you_lose(char c1, char c2, char c3, char c4)
{
  printf("You lose! The good combination was : %c %c %c %c\n", c1,c2,c3,c4);
  fflush(0);
}


int validate(char * c1, char * c2, int* score)
{
   if (*c1 == *c2) {
      *score +=1;
      *c2 = 'x';
      return 1;
   }
   return 0;
}

// ======================================================================
void match(char * ct, char * c1, char * c2, char * c3, int * score)
{
   if (!validate(ct,c1,score)) {
      if (!validate(ct,c2,score)) { 
         validate(ct,c3,score);
      }
   }
}

// ======================================================================
void show_answers(char c1, char c2, char c3, char c4,
                       char r1, char r2, char r3, char r4)
{
  int good = 0;
  int almost = 0;
  int g1,g2,g3,g4;
  g1 = validate(&c1,&r1,&good);
  g2 = validate(&c2,&r2,&good);
  g3 = validate(&c3,&r3,&good);
  g4 = validate(&c4,&r4,&good);
  if (!g1) {
    match(&c1,&r2,&r3,&r4,&almost);
  }
  if (!g2) {
    match(&c2,&r1,&r3,&r4,&almost);
  }
  if (!g3) {
    match(&c3,&r1,&r2,&r4,&almost);
  }
  if (!g4) {
    match(&c4,&r1,&r2,&r3,&almost);
  }
  show_char(good, '#');
  show_char(almost, '+');
  show_char(4-good-almost, '-');
}

// ======================================================================
int win(char c1, char c2, char c3, char c4,
           char r1, char r2, char r3, char r4)
{
   return ((c1==r1)&&(c2==r2)&&(c3==r3)&&(c4==r4));
}


void play(int max)
{
   int nb = 0;
   int n = 0;
   char c[6];
   char s[4];
   char yesno[4];

   srand(time(0));

   s[0] = get_rand(rand());
   s[1] = get_rand(rand());
   s[2] = get_rand(rand());
   s[3] = get_rand(rand());



   sleep(1);
   printf("Initialize phone route system\n");
   for(int cpt=0;cpt<32;cpt++)
   {
      printf(".");
      fflush(0);
      usleep(100000);
   }
   printf("\nWelcome to virual dimension inc.\n");
   printf("Fear is our business\n");
   printf("Hackers will be aggressively prosecuted\nDO YOU WISH TO ENTER?\n");
   fflush(0);
   n = read(1, yesno, 3);
   if (n>0)
   {
      if ((yesno[0] == 'Y') && (yesno[1] == 'E') && (yesno[2]== 'S'))
      {
         printf("Encryption breaker initializing...\n");
         printf("Welcome to Scream III system database\n");
         fflush(0);
         usleep(500000);
         printf("Lame 3d animation is not our strongest asset, how about a good game of mastermind ?\n");
         printf("You have maximum %d attempts! Beat me in 1 and you shall get a reward!\n", max);
         fflush(0);
      }
      else
      {
         printf("Coward!\n");
         fflush(0);
         exit(1);
      }
   }
   fflush(0);

   int cgagne = 0;

   do {
      printf("%s\n",taunts[nb]);
      fflush(0);
      ++nb;
      do {
        printf(" %%%d Enter 4 colors : ", nb);
        fflush(0);
        scanf("%4s",c);
      } while (!validate_colors(c));

      show_nb(c[0],c[1],c[2],c[3],s[0],s[1],s[2],s[3]);
      cgagne = win(c[0],c[1],c[2],c[3],s[0],s[1],s[2],s[3]);
   } while ( (!cgagne) && (nb < max) );

   if (cgagne) {
      you_win(nb);
   } else {
      you_lose(s[0],s[1],s[2],s[3]);
   }

}

int main()
{
  play(8);
  return 0;
}
