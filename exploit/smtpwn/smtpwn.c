#include <time.h>
#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <pwd.h>

#define FLAG_SIZE             100
#define MSG_ID_SIZE           32
#define MSG_DATE_SIZE         200
#define MSG_USER_SIZE         150
#define MSG_HOSTNAME_SIZE     200
#define MSG_CONTENT_SIZE      1024

#define FLAG_PATH             "/home/smtpwn/flag"
#define RANDOM_PATH           "/dev/urandom"
#define OUTFILE_BASEDIR       "/tmp/"
#define OUTFILE_PREFIX        "mail"

#define DATE_FORMAT \
	"%a, %d %B %Y %T %z"

#define MSG_FORMAT \
	"Message-ID: <%1$s>\r\n" \
	"From: \"%2$s\" <%2$s@%4$s>\r\n" \
	"To: \"%3$s\" <%3$s@%4$s>\r\n" \
	"Date: %5$s\r\n" \
	"X-Flag: %6$s\r\n" \
	"Subject: Read this message to get the flag!\r\n" \
	"\r\n%7$s\r\n.\r\n"

#define fail() fputs("[-] An error occured\n", stderr)

struct message {
	char id[MSG_ID_SIZE+ 1];
	char from[MSG_USER_SIZE + 1];
	char to[MSG_USER_SIZE + 1];
	char hostname[MSG_HOSTNAME_SIZE + 1];
	char date[MSG_DATE_SIZE + 1];
	char flag[FLAG_SIZE + 1];
	char content[MSG_CONTENT_SIZE + 1];
	ssize_t len;
};

int hexdigest(char *dst, char *src, size_t size)
{
	while (size--) {
		if (sprintf(dst, "%02x", (unsigned char)*src++) != 2) {
			return 1;
		}

		dst += 2;
	}

	return 0;
}

void get_msg_infos(struct message *msg)
{
	int flag_fd = -1;
	int urandom_fd = -1;
	char random[MSG_ID_SIZE / 2];
	time_t t;
	struct tm *tmp;
	struct passwd *pw;

	puts("Please enter your message:");

	if (/* read user message */
	    ((msg->len = read(STDIN_FILENO, msg->content, MSG_CONTENT_SIZE)) < 0) ||

	    /* get user name */
	    ((pw = getpwuid(getuid())) == NULL) ||
	    (!strncpy(msg->from, pw->pw_name, sizeof(msg->from) - 1)) ||

	    /* get hostname */
	    (gethostname(msg->hostname, MSG_HOSTNAME_SIZE) == -1) ||

	    /* create date string */
	    ((t = time(NULL)) == -1) ||
	    ((tmp = localtime(&t)) == NULL) ||
	    (strftime(msg->date, sizeof(msg->date), DATE_FORMAT, tmp) == 0) ||

	    /* read flag */
	    ((flag_fd = open(FLAG_PATH, O_RDONLY)) == -1) ||
	    (read(flag_fd, msg->flag, FLAG_SIZE) < 0) ||

	    /* generate random Message-ID  */
	    ((urandom_fd = open(RANDOM_PATH, O_RDONLY)) == -1) ||
	    (read(urandom_fd, random, sizeof(random)) != sizeof(random)) ||
	    (hexdigest(msg->id, random, sizeof(random)))

	    ) {
		    fail();
	    }

	close(flag_fd);
	close(urandom_fd);
}

int main(int argc, const char *argv[])
{
	char buf[FLAG_SIZE + MSG_CONTENT_SIZE + sizeof(MSG_FORMAT) + 200];
	struct message msg;
	char filename[sizeof(OUTFILE_BASEDIR) + sizeof(msg.id) + 20];
	int len;
	char *checksum;
	int fd;

	memset(&msg, 0, sizeof(msg));
	get_msg_infos(&msg);

	strcpy(msg.to, "flagholder");

	msg.content[msg.len] = '\0';

	if (/* open output file */
	    (snprintf(filename, sizeof(filename) - 1, "%s%s_%lu_%s",
	              OUTFILE_BASEDIR, OUTFILE_PREFIX, time(NULL), msg.id) < 0) ||
	    ((fd = open(filename, O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR)) == -1) ||

	    /* write message */
	    (snprintf(buf, sizeof(buf), MSG_FORMAT,
	              msg.id, msg.from, msg.to, msg.hostname,
	              msg.date, msg.flag, msg.content) < 0) ||
	    (write(fd, buf, strlen(buf)) == -1)) {
		fail();
	}

	close(fd);

	checksum = MD5File(filename, NULL);

	printf("Message %s (checksum: %s) was sent and...\n", msg.id, checksum);
	unlink(filename);
	printf("destroyed.\n");

	free(checksum);

	return 0;
}
